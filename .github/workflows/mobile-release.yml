name: mobile-release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      MOBILE_WEB_URL: ${{ vars.MOBILE_WEB_URL }}
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Install dependencies
        run: npm ci

      - name: Inject mobile web URL
        run: |
          node -e "const fs=require('fs');const p='android/app/src/main/assets/capacitor.config.json';const cfg=JSON.parse(fs.readFileSync(p,'utf8'));const url=String(process.env.MOBILE_WEB_URL||cfg.server?.url||'https://mini-hbut-video-online.hf.space').trim();cfg.server=cfg.server||{};cfg.server.url=url;cfg.server.cleartext=url.startsWith('http://');fs.writeFileSync(p,JSON.stringify(cfg,null,2));"
          cat android/app/src/main/assets/capacitor.config.json

      - name: Configure Android SDK path
        run: |
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > android/local.properties

      - name: Build Android APK (debug)
        run: |
          cd android
          ./gradlew assembleDebug

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: watch-together-android-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error

  build-ios:
    runs-on: macos-latest
    permissions:
      contents: read
    env:
      MOBILE_WEB_URL: ${{ vars.MOBILE_WEB_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Inject mobile web URL
        run: |
          node -e "const fs=require('fs');const p='ios/App/App/capacitor.config.json';const cfg=JSON.parse(fs.readFileSync(p,'utf8'));const url=String(process.env.MOBILE_WEB_URL||cfg.server?.url||'https://mini-hbut-video-online.hf.space').trim();cfg.server=cfg.server||{};cfg.server.url=url;cfg.server.cleartext=url.startsWith('http://');fs.writeFileSync(p,JSON.stringify(cfg,null,2));"
          cat ios/App/App/capacitor.config.json

      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install

      - name: Build iOS app bundle (unsigned)
        run: |
          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build/ios \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Archive iOS artifact
        run: |
          cd build/ios/Build/Products/Debug-iphonesimulator
          zip -r ../../../../watch-together-ios-simulator.zip App.app

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: watch-together-ios-simulator
          path: build/watch-together-ios-simulator.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs:
      - build-android
      - build-ios
    permissions:
      contents: write
    steps:
      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: watch-together-android-apk
          path: release-assets

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: watch-together-ios-simulator
          path: release-assets

      - name: Generate release tag
        id: release_tag
        run: echo "tag=mobile-${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          name: Watch Together Mobile Build ${{ github.run_number }}
          generate_release_notes: true
          files: |
            release-assets/app-debug.apk
            release-assets/watch-together-ios-simulator.zip
