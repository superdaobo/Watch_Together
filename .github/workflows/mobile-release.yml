name: mobile-release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-android:
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      MOBILE_WEB_URL: ${{ vars.MOBILE_WEB_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Inject mobile web URL
        shell: pwsh
        run: |
          node -e "const fs=require('fs');const p='android/app/src/main/assets/capacitor.config.json';const cfg=JSON.parse(fs.readFileSync(p,'utf8'));const url=String(process.env.MOBILE_WEB_URL||cfg.server?.url||'https://mini-hbut-video-online.hf.space').trim();cfg.server=cfg.server||{};cfg.server.url=url;cfg.server.cleartext=url.startsWith('http://');fs.writeFileSync(p,JSON.stringify(cfg,null,2));"
          Get-Content android/app/src/main/assets/capacitor.config.json

      - name: Configure Android SDK path
        shell: pwsh
        run: |
          $sdk = $env:ANDROID_SDK_ROOT
          if (-not $sdk) {
            $sdk = $env:ANDROID_HOME
          }
          if (-not $sdk) {
            throw "ANDROID_SDK_ROOT and ANDROID_HOME are empty"
          }
          $escaped = $sdk -replace '\\', '\\\\'
          "sdk.dir=$escaped" | Out-File -FilePath android/local.properties -Encoding ascii -Force

      - name: Install Android build components
        shell: pwsh
        run: |
          sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      - name: Build Android APK (debug)
        id: android_build
        shell: pwsh
        continue-on-error: true
        run: |
          Set-Location android
          .\gradlew.bat assembleDebug --stacktrace --warning-mode all *>&1 | Tee-Object -FilePath ..\android-build.log
          exit $LASTEXITCODE

      - name: Upload Android build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: watch-together-android-build-log
          path: android-build.log
          if-no-files-found: warn

      - name: Fail when Android build fails
        if: steps.android_build.outcome != 'success'
        shell: pwsh
        run: |
          $tail = ""
          if (Test-Path android-build.log) {
            $tail = (Get-Content android-build.log -Tail 140) -join "`n"
            Write-Output $tail
          }
          throw "Android build failed. Recent log tail:`n$tail"

      - name: Upload Android artifact
        if: steps.android_build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: watch-together-android-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error

  build-ios:
    runs-on: macos-latest
    permissions:
      contents: read
    env:
      MOBILE_WEB_URL: ${{ vars.MOBILE_WEB_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Inject mobile web URL
        run: |
          node -e "const fs=require('fs');const p='ios/App/App/capacitor.config.json';const cfg=JSON.parse(fs.readFileSync(p,'utf8'));const url=String(process.env.MOBILE_WEB_URL||cfg.server?.url||'https://mini-hbut-video-online.hf.space').trim();cfg.server=cfg.server||{};cfg.server.url=url;cfg.server.cleartext=url.startsWith('http://');fs.writeFileSync(p,JSON.stringify(cfg,null,2));"
          cat ios/App/App/capacitor.config.json

      - name: Build iOS app (unsigned, iphoneos)
        run: |
          xcodebuild \
            -project ios/App/App.xcodeproj \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build/ios \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            build

      - name: Package unsigned iOS IPA
        run: |
          mkdir -p build/ios/ipa/Payload
          cp -R build/ios/Build/Products/Release-iphoneos/App.app build/ios/ipa/Payload/
          cd build/ios/ipa
          zip -r ../watch-together-ios-unsigned.ipa Payload

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: watch-together-ios-unsigned-ipa
          path: build/ios/watch-together-ios-unsigned.ipa
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs:
      - build-android
      - build-ios
    permissions:
      contents: write
    steps:
      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: watch-together-android-apk
          path: release-assets

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: watch-together-ios-unsigned-ipa
          path: release-assets

      - name: Generate release tag
        id: release_tag
        run: echo "tag=mobile-${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          name: Watch Together Mobile Build ${{ github.run_number }}
          generate_release_notes: true
          files: |
            release-assets/app-debug.apk
            release-assets/watch-together-ios-unsigned.ipa
